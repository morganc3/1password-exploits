## Overview
This repository contains the following:
- Proof-of-Concept code for exploiting the Browser Helper XPC bypass vulnerability discussed in the DEFCON 32 presentation. 
- Frida scripts to:
  - Bypass application-level fingerprint check on macOS by hooking `evaluatePolicy` method
  - Inspect an application's interactions with the macOS keychain
  - Proxy and inspect messages sent through a [Native Messaging Host](https://developer.chrome.com/docs/extensions/develop/concepts/native-messaging)

Usage instructions for each above item can be found below. 

Further content including end-to-end PoCs for all vulnerabiltiies will be eventually released 
after fixes are fully implemented and time has been given for users to patch. 

## Exploiting Browser Helper XPC Bypass vulnerability
This exploit will use dynamic library injection to inject into 1Password 6, and then send 
XPC messages to Browser Helper's XPC server. In response, the server will return the
Master Unlock Key / Account Unlock Key. 

This exploit was fixed in April 2024 and affects versions < 8.10.30. 
In order for the exploit to succeed, 1Password must be unlocked. 

To build the dynamic library: 
`gcc -dynamiclib -framework Foundation ./dylib_inject_exploit/dylib_inject_exploit.m -o ./bins/exploit.dylib`

To run the exploit: 
`DYLD_INSERT_LIBRARIES=./bins/exploit.dylib ./dylib_inject_exploit/1Password\ 6.app/Contents/MacOS/1Password\ 6`

## Frida Scripts

To use these scripts, [frida](https://frida.re/docs/installation/) must be installed and [SIP](https://developer.apple.com/documentation/security/disabling_and_enabling_system_integrity_protection?language=objc) must be disabled on your Mac. 

These scripts were useful in our 1Password research, but the concepts for each of them extend macOS applications in general.

### Bypass application-level fingerprint check on macOS by hooking evaluatePolicy method
This frida script will hook [evaluatePolicy](https://developer.apple.com/documentation/localauthentication/lacontext/evaluatepolicy(_:localizedreason:reply:)?language=objc) and make it return true, regardless of if the authentication is successful. 

This will help determine if an authentication prompt is being implemented at the application-level or at the Keychain level. 

`frida -l ./frida/fingerprint_bypass.js -n <program_name>`

### Inspect an application's interactions with the macOS Keychain
This frida script will hook methods that interact with the Keychain, to debug how an 
application is interacting with it. As written, it will hook [SecItemCopyMatching](https://developer.apple.com/documentation/security/1398306-secitemcopymatching) and log both the query parameters passed to the method, and the object 
returned from the keychain. The code near the bottom of the script can additionally be commented out to hook and log 
calls to [SecKeyCreateDecryptedData](https://developer.apple.com/documentation/security/1644043-seckeycreatedecrypteddata?language=objc).

`frida -l ./frida/inspect_keychain.js -n <program_name>`

### Proxy and inspect messages sent through a Native Messaging Host
This frida script will hook "read" and "write", to capture STDIN/STDOUT communications passed through a Native Messaging Host. 

`frida -l ./frida/nmh.js -n <nmh_program_name>`